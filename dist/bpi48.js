async function wapper(){const VERSION="v.1.0.0.beta";const PLAY_DATA_URL="https://p.eagate.573.jp/game/popn/unilab/playdata";const MEDAL_IMAGE_URL="https://eacache.s.konaminet.jp/game/popn/unilab/images/p/common/medal";const SONGS=[{"song":"Aithon","avg":2109,"max":2284,"wr":2264},{"song":"Alia Dimensiva","avg":2566,"max":2948,"wr":2900},{"song":"ANNIVERSARY ∴∵∴ ←↓↑→","avg":2266,"max":2496,"wr":2475},{"song":"asteer","avg":2636,"max":2898,"wr":2861},{"song":"BabeL ～Grand Story～","avg":2832,"max":3072,"wr":3044},{"song":"Battle Against a True Hero/本物のヒーローとの戦い","avg":2762,"max":3000,"wr":2980},{"song":"Celsus Ⅱ","avg":2869,"max":3032,"wr":3024},{"song":"CHIP'N'RIDDIM","avg":2422,"max":2700,"wr":2685},{"song":"Chronoxia","avg":2752,"max":3030,"wr":3017},{"song":"Concertare","avg":1492,"max":1696,"wr":1687},{"song":"Concertino In Blue","avg":2354,"max":2608,"wr":2581},{"song":"cucumis melo","avg":2294,"max":2626,"wr":2605},{"song":"DDR MEGAMIX","avg":2003,"max":2458,"wr":2423},{"song":"Dimensiva Vulnus","avg":2273,"max":2514,"wr":2492},{"song":"Doll's sight","avg":1276,"max":1492,"wr":1478},{"song":"Dracophobia","avg":2536,"max":2888,"wr":2834},{"song":"DUAL STRIKER","avg":2573,"max":2788,"wr":2769},{"song":"Ergosphere","avg":2448,"max":2648,"wr":2622},{"song":"Esperanza","avg":2617,"max":2894,"wr":2854},{"song":"Evans","avg":2431,"max":2678,"wr":2665},{"song":"fffff","avg":2167,"max":2440,"wr":2416},{"song":"fffff op.2","avg":2516,"max":2868,"wr":2801},{"song":"FLOWER","avg":2573,"max":2848,"wr":2832},{"song":"forever under construction","avg":2359,"max":2598,"wr":2580},{"song":"Funky sonic World","avg":2621,"max":2864,"wr":2851},{"song":"GAIA","avg":2598,"max":2936,"wr":2902},{"song":"Globe Glitter","avg":2450,"max":2722,"wr":2688},{"song":"GOLDEN CROSS","avg":2521,"max":2770,"wr":2763},{"song":"good night , mommy","avg":2541,"max":2778,"wr":2763},{"song":"Grand Chariot","avg":2473,"max":2746,"wr":2726},{"song":"Gray clouds","avg":2559,"max":2808,"wr":2793},{"song":"hora de verdad","avg":1916,"max":2192,"wr":2144},{"song":"Idola","avg":2721,"max":2936,"wr":2929},{"song":"Indigo Nocturne","avg":2523,"max":2746,"wr":2727},{"song":"JOMANDA","avg":2648,"max":3030,"wr":2995},{"song":"KETER","avg":2372,"max":2572,"wr":2549},{"song":"La fame di Adria","avg":2172,"max":2396,"wr":2361},{"song":"LEAD Gravity（M）","avg":2684,"max":2956,"wr":2927},{"song":"Leaf","avg":2710,"max":3044,"wr":3017},{"song":"Life is beautiful","avg":2375,"max":2708,"wr":2669},{"song":"Little prayer","avg":2761,"max":3064,"wr":3048},{"song":"Macuilxochitl","avg":2592,"max":2868,"wr":2847},{"song":"MADSPEED狂信道","avg":2349,"max":2650,"wr":2615},{"song":"Majestaria","avg":2648,"max":2866,"wr":2850},{"song":"MEGALOVANIA","avg":2588,"max":2812,"wr":2787},{"song":"Metamorphose","avg":2779,"max":3068,"wr":3043},{"song":"Mirage Age","avg":2427,"max":2642,"wr":2626},{"song":"MVA","avg":2279,"max":2556,"wr":2529},{"song":"NOBUNAGA","avg":2334,"max":2532,"wr":2525},{"song":"Northern Cross","avg":2749,"max":3034,"wr":3014},{"song":"nostos","avg":2669,"max":3058,"wr":2999},{"song":"OVERHEAT -Type P-","avg":2244,"max":2538,"wr":2508},{"song":"POP-STEP-UP","avg":1636,"max":2016,"wr":1990},{"song":"Puberty Dysthymia","avg":2437,"max":2710,"wr":2678},{"song":"Raison d'être～交差する宿命～","avg":2682,"max":2986,"wr":2956},{"song":"Red Roses","avg":2135,"max":2350,"wr":2339},{"song":"Russian Caravan Rhapsody","avg":2443,"max":2682,"wr":2659},{"song":"Sanctum Crusade","avg":2495,"max":2760,"wr":2725},{"song":"saQrifice","avg":2304,"max":2550,"wr":2532},{"song":"Southern Cross","avg":2386,"max":2622,"wr":2607},{"song":"STULTI","avg":2247,"max":2576,"wr":2543},{"song":"SYMPHONY FROM ZERO","avg":2364,"max":2640,"wr":2620},{"song":"The Least 100 sec","avg":2429,"max":2608,"wr":2591},{"song":"Trill auf G","avg":2335,"max":2610,"wr":2579},{"song":"Trixxxter","avg":2597,"max":2896,"wr":2873},{"song":"True Blue","avg":2613,"max":2804,"wr":2794},{"song":"ULTRA BUTTERFLY(坤剛力)","avg":2149,"max":2434,"wr":2402},{"song":"Vairocana","avg":1922,"max":2212,"wr":2180},{"song":"Valanga","avg":2799,"max":2996,"wr":2989},{"song":"voltississimo","avg":2642,"max":2966,"wr":2931},{"song":"Warriors Aboot","avg":2600,"max":2826,"wr":2809},{"song":"ZADAMGA","avg":2677,"max":2978,"wr":2940},{"song":"ZETA～素数の世界と超越者～","avg":2449,"max":2662,"wr":2638},{"song":"生きてこそ～特別版～","avg":2626,"max":2800,"wr":2783},{"song":"一激必翔","avg":2809,"max":3070,"wr":3040},{"song":"御千手メディテーション","avg":2399,"max":2674,"wr":2653},{"song":"踊るフィーバーロボ","avg":2327,"max":2622,"wr":2596},{"song":"カーニバルの主題による人形のためのいびつな狂想曲","avg":2261,"max":2512,"wr":2490},{"song":"蛇神","avg":2735,"max":2980,"wr":2968},{"song":"金縛りの逢を","avg":2823,"max":3048,"wr":3041},{"song":"カラフルトイズ・ワンダーランド","avg":2809,"max":3070,"wr":3045},{"song":"カラルの月","avg":2505,"max":2806,"wr":2763},{"song":"賢聖シリウスの采配","avg":2631,"max":2928,"wr":2898},{"song":"現代のヘイヨエ祭り","avg":2808,"max":3070,"wr":3044},{"song":"子供の落書き帳","avg":2054,"max":2392,"wr":2361},{"song":"コドモライブ","avg":2723,"max":2916,"wr":2897},{"song":"混乱少女♥そふらんちゃん!!","avg":2131,"max":2520,"wr":2477},{"song":"流離","avg":2639,"max":2876,"wr":2859},{"song":"雫","avg":2694,"max":2888,"wr":2864},{"song":"灼熱Beach Side Bunny","avg":2660,"max":2912,"wr":2890},{"song":"序","avg":2724,"max":3072,"wr":3026},{"song":"少女と時の花","avg":2535,"max":2762,"wr":2727},{"song":"人妖絵巻其の三「鴉天狗」～ 鞍馬のHAYATE ～","avg":2481,"max":2714,"wr":2687},{"song":"スーパー戦湯ババンバーン","avg":2659,"max":2906,"wr":2886},{"song":"翠雨の祷","avg":2342,"max":2590,"wr":2560},{"song":"進め！爺ちゃん！","avg":2026,"max":2504,"wr":2398},{"song":"西軍||∴⊂SEKIGAHARA⊃∴||東軍","avg":2109,"max":2344,"wr":2332},{"song":"青天ノ霹レキ","avg":2772,"max":3000,"wr":2986},{"song":"雪上断火","avg":2922,"max":3100,"wr":3072},{"song":"創世ノート","avg":2758,"max":3072,"wr":3050},{"song":"多極性ニューロンの崩壊による人間の末路","avg":2541,"max":2842,"wr":2821},{"song":"たまごの物理科学的 及び調理特性に関しての調査、そしてその考察","avg":2304,"max":2490,"wr":2473},{"song":"テンプラ揚三","avg":1769,"max":1936,"wr":1909},{"song":"天ぷらイントロドン！！","avg":2658,"max":3002,"wr":2980},{"song":"轟け！恋のビーンボール！！","avg":2652,"max":2858,"wr":2839},{"song":"バイキングマン","avg":2354,"max":2634,"wr":2581},{"song":"背水之陣 (Kagutsuchi Remix)","avg":2478,"max":2802,"wr":2776},{"song":"背徳と邪悪のエピタフ","avg":2245,"max":2526,"wr":2506},{"song":"万物快楽理論","avg":2668,"max":2940,"wr":2905},{"song":"火風陸空","avg":2706,"max":2890,"wr":2877},{"song":"風林火山","avg":1943,"max":2190,"wr":2160},{"song":"ホーンテッド★メイドランチ","avg":2787,"max":3068,"wr":3050},{"song":"ポチコの幸せな日常 (狂犬U`x´UばうわうHARDCORE Remix)","avg":2556,"max":2872,"wr":2842},{"song":"ポルターガイスト","avg":2303,"max":2552,"wr":2523},{"song":"祭ノ痕、君ヲ憶フ。","avg":2185,"max":2432,"wr":2401},{"song":"魔法のかくれんぼ","avg":2489,"max":2860,"wr":2799},{"song":"ミサコの告白（みーつけたっ♥）","avg":2615,"max":2820,"wr":2805},{"song":"蟲の棲む処","avg":1905,"max":2114,"wr":2083},{"song":"夜間行","avg":1620,"max":1816,"wr":1783},{"song":"野獣ワイルド","avg":2647,"max":2842,"wr":2837},{"song":"夢について　TYPE C","avg":2226,"max":2422,"wr":2410},{"song":"龍王の霊廟(Mausoleum Of The Primal Dragon)","avg":2571,"max":2758,"wr":2740},{"song":"量子の海のリントヴルム","avg":2492,"max":2698,"wr":2692},{"song":"リリーゼと炎龍レーヴァテイン","avg":2756,"max":3006,"wr":2990},{"song":"霖が哭く","avg":2638,"max":2936,"wr":2918},{"song":"輪廻の鴉","avg":2590,"max":2784,"wr":2772},{"song":"霊魂爆砕 -SOUL EXPLOSION-","avg":2510,"max":2740,"wr":2726},{"song":"令和の国","avg":2365,"max":2618,"wr":2574},{"song":"煉獄事変","avg":2594,"max":2918,"wr":2880},{"song":"路男","avg":2924,"max":3208,"wr":3200},{"song":"海神","avg":2678,"max":2864,"wr":2856}];const domparser=new DOMParser();const ConvToUTF8=(res)=>{return res.arrayBuffer().then((buffer)=>{if(res.headers.get("Content-Type").includes("UTF-8")){return new TextDecoder().decode(buffer)}else{return new TextDecoder("Shift_JIS").decode(buffer)}})};const idx=await fetch(`${PLAY_DATA_URL}/index.html`).then(ConvToUTF8).then(text=>domparser.parseFromString(text,"text/html"));const player=idx.querySelector("#status_table > div.st_box > div:nth-child(2)").textContent;const chara=idx.getElementsByTagName('img').item(9).getAttribute("src");const GetMusicData=(url,level)=>{return fetch(url).then(ConvToUTF8).then(text=>domparser.parseFromString(text,"text/html")).then(doc=>doc.querySelectorAll("ul.mu_list_table > li")).then(list=>{return Array.from(list).filter(li=>li.firstElementChild.className.startsWith("col")).map(li=>[li.firstElementChild.firstElementChild.textContent,li.firstElementChild.lastElementChild.textContent,li.children[3].textContent,li.children[3].firstChild.src.replace(`${MEDAL_IMAGE_URL}/meda_`,"").replace(".png",""),]).map(([song,genre,score,medal])=>{return{song,genre,score,medal,level}})})};const promises=[[0,48],[1,48],[2,48],[3,48],[4,48],[5,48],[6,48],].map(([page,level])=>GetMusicData(`${PLAY_DATA_URL}/mu_lv.html?page=${page}&level=${level}`,level));let music_data=(await Promise.all(promises)).flat();const POW=1.175;const MINBPI=0;const CalcBPI=(s,k,z,m)=>{const CalcPGF=(x)=>{return x===m?m*2:1+(x/m-0.5)/(1-x/m)};const S=CalcPGF(s);const K=CalcPGF(k);const Z=CalcPGF(z);const S_=S/K;const Z_=Z/K;if(s>=k){const result=(100*(Math.pow(Math.log(S_),POW)/Math.pow(Math.log(Z_),POW)));return Math.max(MINBPI,Math.round(result*100)/100)}else{const result=(-100*(Math.pow(-Math.log(S_),POW)/Math.pow(Math.log(Z_),POW)));return Math.max(MINBPI,Math.round(result*100)/100)}};const CalcAvgBPI=(music_num,music_data)=>{const coef=Math.log2(music_num);const sumbpi=music_data.reduce((sum,i)=>sum+(Math.pow(Number(i.bpi),coef))/music_num,0);const result=Math.pow(sumbpi,1/coef);return Math.round(result*100)/100};Object.keys(music_data).map(item=>{const SONG=SONGS.find(({song})=>song===music_data[item].song);if(SONG){const bmscore=Math.round(SONG.max*(1-(100000-music_data[item].score)/60000));if(bmscore>0){const bpi=CalcBPI(bmscore,SONG.avg,SONG.wr,SONG.max);music_data[item].bpi=Math.max(bpi,MINBPI)}else{music_data[item].bpi=MINBPI}}else{console.log(music_data[item].song);music_data[item].bpi=MINBPI}});music_data=music_data.filter(a=>!!a);music_data.sort((a,b)=>{if(a.score<b.score)return 1;if(a.score>b.score)return-1;return 0});music_data.sort((a,b)=>{if(a.bpi<b.bpi)return 1;if(a.bpi>b.bpi)return-1;return 0});const avg_data=music_data.filter(i=>i.score!=0);const avg_score=Math.round(avg_data.reduce((sum,i)=>sum+Number(i.score),0)/avg_data.length);const avg_bpi=CalcAvgBPI(music_data.length,music_data);const top=music_data.slice(0,30);const bottom=music_data.slice(-30);Object.keys(music_data).map(item=>{if(music_data[item].song.length>20){music_data[item].song=music_data[item].song.substr(0,20)+'...'}});const divEl=document.createElement("div");divEl.id="popnRadar";divEl.innerHTML=` <style scoped> .popnPage { display: flex; justify-content: center; color: #FFFFFF; background-color: #2D2D2D } .popnTable { background-color: #0D0D0D; border-collapse: collapse; } .popnTable caption { text-align: center; back-ground: #0D0D0D; } .popnTable tr { border-bottom: 2px solid #2D2D2D; } .popnTable th { padding: 4px; } .popnTable td { padding: 0 4px; white-space: nowrap; } .popnTable td img { vertical-align: middle; } .profileTable { margin: 5px auto; font-size: 14px; background-color: #0D0D0D; border-collapse: collapse; } .profileTable tr { border-bottom: 2px solid #2D2D2D; } .profileTable td { width: 175px; padding: 5px; } .profileTable td:first-child { font-weight: bold; } .profileTable canvas { position: right; width: 350px; height: 2500px; } .footnote { font-size: 10px; margin: 8px auto; color: gray; text-align: center; } @media (max-width: 768px) { .popnPage { flex-direction: column; } .popnTable { width: 100%; margin-bottom: 20px; } .profileTable { width: auto; } .popnTable th:first-child,td:first-child { min-width: 20px; } .popnTable th:nth-child(4),td:nth-child(4) { min-width: 40px; } .popnTable th:nth-child(5),td:nth-child(5) { min-width: 40px; } .popnTable th:nth-child(6),td:nth-child(6) { min-width: 50px; } } </style> <div class="popnPage"> <table class="profileTable"> <tr> <td>プレーヤー名</td> <td>${player}</td> </tr> <tr> <td>使用キャラクター</td> <td><img src="${chara}"></td> </tr> <tr> <td>平均スコア</td> <td>${avg_score}</td> </tr> <tr> <td>総合BPI</td> <td>${avg_bpi}</td> </tr> </table> </div> <div class="popnPage"> <table class="popnTable"> <caption>TOP 30</caption> <tr> <th>BPI</th> <th>LV</th> <th>曲名</th> <th>スコア</th> <th>メダル</th> </tr> ${top.map(x => `<tr><td>${x.bpi}</td><td>${x.level}</td><td width=250px>${x.song}</td><td>${x.score}</td><td><img src="${MEDAL_IMAGE_URL}/meda_${x.medal}.png"></td></tr>` ).join("")} </table> <table class="popnTable"> <caption>BOTTOM 30</caption> <tr> <th>BPI</th> <th>LV</th> <th>曲名</th> <th>スコア</th> <th>メダル</th> </tr> ${bottom.map(x => `<tr><td>${x.bpi}</td><td>${x.level}</td><td width=250px>${x.song}</td><td>${x.score}</td><td><img src="${MEDAL_IMAGE_URL}/meda_${x.medal}.png"></td></tr>` ).join("")} </table> </div> <div class="footnote">pop'n music BPI calculator ${VERSION}</div> `;document.body.innerHTML="";document.body.appendChild(divEl)} wapper()